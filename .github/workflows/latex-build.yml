name: Build CV (LuaLaTeX)

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      use_tinytex:
        description: 'Install TinyTeX instead of apt texlive'
        required: false
        default: 'false'
      publish_release:
        description: 'Publish the built PDF to a GitHub Release'
        required: false
        default: 'false'
      release_tag:
        description: 'Tag name to use for the Release (optional)'
        required: false
      release_name:
        description: 'Release name (optional)'
        required: false
  release:
    types:
      - created
      - published

jobs:
  build:
    name: Build example/cv.pdf
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install TeX dependencies (apt-get)
        if: ${{ github.event.inputs.use_tinytex != 'true' }}
        continue-on-error: true
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            latexmk texlive-latex-recommended texlive-latex-extra texlive-luatex texlive-xetex texlive-fonts-recommended texlive-fonts-extra texlive-bibtex-extra biber fonts-font-awesome lmodern texlive-lang-french texlive-pictures

      - name: Install TinyTeX (alternative)
        if: ${{ github.event.inputs.use_tinytex == 'true' }}
        run: |
          curl -sL 'https://yihui.org/tinytex/install-bin-unix.sh' | sh -s - -y
          echo "$HOME/bin" >> $GITHUB_PATH
          tlmgr update --self
          tlmgr install latexmk biber collection-latexrecommended collection-latexextra collection-luatex collection-langfrench collection-fontsrecommended fontawesome5 csquotes

      - name: Diagnostics: TeX and system versions
        run: |
          echo "PATH=$PATH"
          echo "LaTeX tools present:"
          command -v latexmk || true
          command -v lualatex || true
          latexmk --version || true
          lualatex --version || true
          echo "dpkg package list for TeX-related packages (first 40 lines):"
          dpkg -l | grep -i tex | head -n 40 || true

      - name: Ensure TeX tools (fallback to TinyTeX if missing)
        run: |
          if ! command -v latexmk >/dev/null 2>&1 || ! command -v lualatex >/dev/null 2>&1; then
            echo "latexmk or lualatex missing, installing TinyTeX fallback"
            curl -sL 'https://yihui.org/tinytex/install-bin-unix.sh' | sh -s - -y
            echo "$HOME/bin" >> $GITHUB_PATH
            tlmgr update --self
            tlmgr install latexmk biber collection-latexrecommended collection-latexextra collection-luatex collection-langfrench collection-fontsrecommended fontawesome5 csquotes || true
          else
            echo "latexmk and lualatex found, proceeding"
          fi

      - name: Build the example CV with LuaLaTeX
        working-directory: ./example
        run: latexmk -cd -f -lualatex -interaction=nonstopmode -synctex=1 cv.tex

      - name: Upload PDF artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: cv.pdf
          path: example/cv.pdf

  release:
    name: Publish CV as Release
    runs-on: ubuntu-latest
    needs: build
    if: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_release == 'true') || github.event_name == 'release' || startsWith(github.ref, 'refs/tags/') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download built PDF artifact
        uses: actions/download-artifact@v4
        with:
          name: cv.pdf
          path: ./artifact

      - name: Create Release (if needed)
        if: ${{ github.event_name != 'release' }}
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_tag != '' && github.event.inputs.release_tag || startsWith(github.ref, 'refs/tags/') && replace(github.ref, 'refs/tags/', '') || 'cv-build' }}
          release_name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_name != '' && github.event.inputs.release_name || 'CV build' }}
          draft: false
          prerelease: false

      - name: Determine upload_url
        id: determine_upload
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "upload_url=${{ github.event.release.upload_url }}" >> $GITHUB_OUTPUT
          else
            echo "upload_url=${{ steps.create_release.outputs.upload_url }}" >> $GITHUB_OUTPUT
          fi

      - name: Upload built PDF to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.determine_upload.outputs.upload_url }}
          asset_path: ./artifact/cv.pdf
          asset_name: cv.pdf
          asset_content_type: application/pdf
